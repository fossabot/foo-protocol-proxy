#!/usr/bin/env bash

set -eoux

CURRENT_DIR=$(dirname "$0")
IMAGE_NAME=$IMAGE_NAME
IMAGE_TAG=$IMAGE_TAG
REGISTRY_REPO=$REGISTRY_REPO
CPU_LIMIT='0.50'
MEMORY_LIMIT='500M'
RESERVED_CPU='0.25'
RESERVED_MEMORY='20M'
SERVICE_NAME=$SERVICE_NAME
SERVICE_DESCRIPTION=$SERVICE_DESCRIPTION
MAINTAINER_NAME=$(git config user.name 2> /dev/null)
MAINTAINER_EMAIL=$(git config user.email 2> /dev/null)
GOLANG_VERSION=1
SRC_NAMESPACE=$SRC_NAMESPACE
DOCKER_FILE=$DOCKER_FILE
ENV_FILE=$ENV_FILE
HTTP_PORT=$HTTP_PORT
ARCH=$ARCH
DOCKER_COMPOSE_FILE=".docker-compose-${ARCH}.yaml"

if [[ $IMAGE_NAME == '' ]]; then
    IMAGE_NAME=$IMAGE_NAME
fi

if [[ $IMAGE_TAG == '' ]]; then
    IMAGE_TAG=$(git describe --tags --match 'v[0-9]*' --abbrev=8 --always --dirty='-Changes' | sed 's/^v\(.*\)$/\1/' 2> /dev/null || echo 'dev')
fi

if [[ $REGISTRY_REPO == '' ]]; then
    REGISTRY_REPO="$IMAGE_NAME/$IMAGE_TAG"
fi

. ${CURRENT_DIR}/includes.sh

cat ${CURRENT_DIR}/../templates/docker/docker-compose.template.yaml.dist > $DOCKER_COMPOSE_FILE

replaceInFile '{{IMAGE_NAME}}' $IMAGE_NAME $DOCKER_COMPOSE_FILE
replaceInFile '{{IMAGE_TAG}}' $IMAGE_TAG $DOCKER_COMPOSE_FILE
replaceInFile '{{CONTAINER_NAME}}' "$IMAGE_NAME.$IMAGE_TAG" $DOCKER_COMPOSE_FILE
replaceInFile '{{REGISTRY_REPO}}' $REGISTRY_REPO $DOCKER_COMPOSE_FILE
replaceInFile '{{CPU_LIMIT}}' $CPU_LIMIT $DOCKER_COMPOSE_FILE
replaceInFile '{{MEMORY_LIMIT}}' $MEMORY_LIMIT $DOCKER_COMPOSE_FILE
replaceInFile '{{RESERVED_CPU}}' $RESERVED_CPU $DOCKER_COMPOSE_FILE
replaceInFile '{{RESERVED_MEMORY}}' $RESERVED_MEMORY $DOCKER_COMPOSE_FILE
replaceInFile '{{GOLANG_VERSION}}' $GOLANG_VERSION $DOCKER_COMPOSE_FILE
replaceInFile '{{SRC_NAMESPACE}}' $SRC_NAMESPACE $DOCKER_COMPOSE_FILE
replaceInFile '{{DOCKER_FILE}}' $DOCKER_FILE $DOCKER_COMPOSE_FILE
replaceInFile '{{SERVICE_DESCRIPTION}}' "$SERVICE_DESCRIPTION" $DOCKER_COMPOSE_FILE
replaceInFile '{{SERVICE_NAME}}' "$SERVICE_NAME" $DOCKER_COMPOSE_FILE
replaceInFile '{{MAINTAINER_NAME}}' "$MAINTAINER_NAME" $DOCKER_COMPOSE_FILE
replaceInFile '{{MAINTAINER_EMAIL}}' $MAINTAINER_EMAIL $DOCKER_COMPOSE_FILE
replaceInFile '{{ENV_FILE_PATH}}' $ENV_FILE $DOCKER_COMPOSE_FILE
replaceInFile '{{HTTP_PORT}}' $HTTP_PORT $DOCKER_COMPOSE_FILE
